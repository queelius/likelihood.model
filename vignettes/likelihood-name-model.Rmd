---
title: "Likelihood Named Distributions Model"
output:
    rmarkdown::html_vignette:
        toc: true
vignette: >
  %\VignetteIndexEntry{Likelihood Named Distributions Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
options(digits = 2)
```

## Likelihood Named Distributions Model: `likelihood_name_model`

### Introduction

The `likelihood.model` package introduces a flexible framework for working with
likelihood models in R. Here, we demonstrate a model based on the naming
conventions of distribution functions in R, making it easy to construct
likelihood models for a wide range of distributions and handle different types
of censoring. This vignette provides a brief guide to using the
`likelihood_name_model` within the `likelihood.model` package.

> You can also use these likelihood functions as likelihood contributions in a
> more complicated likelihood contribution model.

### Conceptual Foundation

At the heart of many statistical models lies the concept of likelihood, a fundamental tool in estimating parameters and testing hypotheses. The `likelihood.model` package builds on this foundation, providing a way to generate likelihood models based on named distributions (e.g., normal, exponential) and handle data that may be subject to different censoring mechanismsâ€”such as exact, left-censored, right-censored, or interval-censored observations.

### Getting Started

#### Installation

To begin, install the `likelihood.model` package from GitHub:

```{r}
if (!require(devtools)) {
  install.packages("devtools")
}
devtools::install_github("queelius/likelihood.model")
```

#### Loading the Package

Load the package along with other necessary libraries:

```{r message=FALSE, warning=FALSE}
library(likelihood.model)
library(algebraic.mle)
library(algebraic.dist)
library(dplyr)
```

### Creating a Likelihood Model

Start by creating a simple likelihood model for a normal distribution:

```{r}
model <- likelihood_name("norm", "x", "censoring")
print(model)
```

This model is based on the normal distribution, with `x` as the observation
column and `censoring` as the censoring column that indicates the type of
censoring for the corresponding observation.

### Detailed Example

Let's simulate some data to apply our model:

```{r}
set.seed(123)

generate_data <- function(n, right_censoring_quantile, sampler) {
  df <- data.frame(
    x = sampler(n),
    censoring = rep("exact", n)
  )
  q <- qnorm(right_censoring_quantile)

  for (i in 1:n) {
    if (df[i, 1] > q) {
      df[i, ] <- list(q, "right")
    }
  }
  df
}

df <- generate_data(n = 100, right_censoring_quantile = .5,
                    sampler = function(n) rnorm(n, mean = 0, sd = 1))
```

Now we have a dataset `df` with $n=100$ observations, with
50% ($`right_censoring_quantile` = 0.5$) expected to be right-censored.
Now, compute the log-likelihood of the dataset given the parameters:

```{r}
ll <- loglik(model)
```

#### Fitting the Model

The `fit` function returns a solver that can be used to find the MLE:

```{r}
solver <- fit(model)
mle <- solver(df, par = c(mean = 0, sd = 1))
print(mle)
```

The solver accepts control parameters to customize the optimization algorithm, including the method (`"Nelder-Mead"`, `"BFGS"`, `"SANN"`, etc.), convergence tolerance, and maximum iterations.

```{r}
xs <- seq(-5, 5, 0.1)
ys <- numeric(length(xs))
mle_params <- unname(params(mle))  # strip names to avoid parameter name conflicts
for (i in seq_along(xs)) {
  ys[i] <- ll(df, par = c(mean = xs[i], sd = mle_params[2]))
}
plot(xs, ys, type = "l", xlab = "Mean", ylab = "Log-likelihood")
points(mle_params[1], ll(df, par = mle_params), col = "blue", pch = 19)
for (i in seq_along(xs)) {
  ys[i] <- ll(df, par = c(mean = mle_params[1], sd = xs[i]))
}
lines(xs, ys, col = "red")
points(mle_params[2], ll(df, par = mle_params), col = "blue", pch = 19)
```

We can show the confidence intervals for the parameters:
```{r}
confint(mle)
```
We can do many other tasks, too, See: [algebraic.mle](https://www.github.com/queelius/algebraic.mle)
in addition to the functions availabel in this package.
Since the MLE is itself a distribution, you may also use the [algebraic.dist](https://www.github.com/queelius/algebraic.dist)
to do other tasks, such as expectations.

### Hypothesis Testing

The `likelihood.model` package provides a likelihood ratio test via the `lrt`
function to compare nested models. For example, we can test whether data from
a normal distribution fits better than a simpler exponential model:

```{r}
# Generate test data from exponential distribution
set.seed(456)
df.test <- generate_data(n = 100, right_censoring_quantile = .75,
                         sampler = function(n) rexp(n, rate = 1))

# Fit both models
model_exp <- likelihood_name("exp", "x", "censoring")
model_norm <- likelihood_name("norm", "x", "censoring")

solver_exp <- fit(model_exp)
solver_norm <- fit(model_norm)

mle_exp <- solver_exp(df.test, par = c(rate = 1))
mle_norm <- solver_norm(df.test, par = c(mean = 1, sd = 1))

# Compare log-likelihoods
cat("Exponential log-likelihood:", loglik_val(mle_exp), "\n")
cat("Normal log-likelihood:", loglik_val(mle_norm), "\n")

# Perform LRT (exponential as null, normal as alternative)
# Note: These aren't truly nested, but we can still compare
lrt_result <- lrt(model_exp, model_norm, df.test,
                  null_par = params(mle_exp),
                  alt_par = params(mle_norm),
                  dof = 1)  # normal has 1 more parameter
print(lrt_result)
```
